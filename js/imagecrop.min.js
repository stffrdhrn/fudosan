(function(a){a.imageCrop=function(F,N){var I={allowMove:true,allowResize:true,allowSelect:true,aspectRatio:0,displayPreview:false,displaySizeHint:false,minSelect:[0,0],minSize:[0,0],maxSize:[0,0],outlineOpacity:0.5,overlayOpacity:0.5,previewBoundary:90,previewFadeOnBlur:1,previewFadeOnFocus:0.35,selectionPosition:[0,0],selectionWidth:0,selectionHeight:0,onChange:function(){},onSelect:function(){}};var x=I;o(N);var C=a(F);var R=a("<div />").css({position:"relative"}).width(C.width()).height(C.height());C.wrap(R).css({position:"absolute"});var D=a('<div id="image-crop-overlay" />').css({opacity:x.overlayOpacity,position:"absolute"}).width(C.width()).height(C.height()).insertAfter(C);var s=a("<div />").css({backgroundColor:"#000000",opacity:0,position:"absolute"}).width(C.width()).height(C.height()).insertAfter(D);var M=a('<div id="image-crop-outline" />').css({opacity:x.outlineOpacity,position:"absolute"}).insertAfter(s);var E=a("<div />").css({background:"url("+C.attr("src")+") no-repeat",position:"absolute"}).insertAfter(M);var d=a('<div id="image-crop-size-hint-background" />').css({opacity:0.35,position:"absolute"}).insertAfter(E);var S=a('<span id="image-crop-size-hint-foreground" />').css({position:"absolute"}).insertAfter(d);var c=a('<div class="image-crop-resize-handler" id="image-crop-nw-resize-handler" />').css({opacity:0.5,position:"absolute"}).insertAfter(E);var z=a('<div class="image-crop-resize-handler" id="image-crop-n-resize-handler" />').css({opacity:0.5,position:"absolute"}).insertAfter(E);var J=a('<div class="image-crop-resize-handler" id="image-crop-ne-resize-handler" />').css({opacity:0.5,position:"absolute"}).insertAfter(E);var i=a('<div class="image-crop-resize-handler" id="image-crop-w-resize-handler" />').css({opacity:0.5,position:"absolute"}).insertAfter(E);var T=a('<div class="image-crop-resize-handler" id="image-crop-e-resize-handler" />').css({opacity:0.5,position:"absolute"}).insertAfter(E);var e=a('<div class="image-crop-resize-handler" id="image-crop-sw-resize-handler" />').css({opacity:0.5,position:"absolute"}).insertAfter(E);var k=a('<div class="image-crop-resize-handler" id="image-crop-s-resize-handler" />').css({opacity:0.5,position:"absolute"}).insertAfter(E);var L=a('<div class="image-crop-resize-handler" id="image-crop-se-resize-handler" />').css({opacity:0.5,position:"absolute"}).insertAfter(E);var g=a('<div id="image-crop-preview-holder" />').css({opacity:x.previewFadeOnBlur,overflow:"hidden",position:"absolute"}).insertAfter(M);var p=a('<img alt="Crop preview" id="image-crop-preview" />').css({position:"absolute"}).attr("src",C.attr("src")).appendTo(g);var n=true,B=true,A,r=[0,0],w=[0,0];if(x.selectionWidth>x.minSelect[0]&&x.selectionHeight>x.minSelect[1]){A=true;}else{A=false;}u();if(x.allowSelect){s.mousedown(G);}if(x.allowMove){E.mousedown(j);}if(x.allowResize){a("div.image-crop-resize-handler").mousedown(h);}function o(U){x=a.extend(x,U);}function H(U){var V=a(U).offset();return[V.left,V.top];}function q(V){var W=H(C);var U=V.pageX-W[0],X=V.pageY-W[1];U=(U<0)?0:(U>C.width())?C.width():U;X=(X<0)?0:(X>C.height())?C.height():X;return[U,X];}function l(){return{selectionX:x.selectionPosition[0],selectionY:x.selectionPosition[1],selectionWidth:x.selectionWidth,selectionHeight:x.selectionHeight,selectionExists:function(){return A;}};}function Q(){D.css({display:A?"block":"none"});}function f(){s.css({cursor:x.allowSelect?"crosshair":"default"});}function K(){M.css({cursor:"default",display:A?"block":"none",left:x.selectionPosition[0],top:x.selectionPosition[1]}).width(x.selectionWidth).height(x.selectionHeight);E.css({backgroundPosition:(-x.selectionPosition[0]-1)+"px "+(-x.selectionPosition[1]-1)+"px",cursor:x.allowMove?"move":"default",display:A?"block":"none",left:x.selectionPosition[0]+1,top:x.selectionPosition[1]+1}).width((x.selectionWidth-2>0)?(x.selectionWidth-2):0).height((x.selectionHeight-2>0)?(x.selectionHeight-2):0);}function y(U){switch(U){case"fade-out":d.fadeOut("slow");S.fadeOut("slow");break;default:var V=(A&&x.displaySize)?"block":"none";S.css({cursor:"default",display:V,left:x.selectionPosition[0]+4,top:x.selectionPosition[1]+4}).html(x.selectionWidth+"x"+x.selectionHeight);d.css({cursor:"default",display:V,left:x.selectionPosition[0]+1,top:x.selectionPosition[1]+1}).width(S.width()+6).height(S.height()+6);}}function t(U){switch(U){case"hide-all":a(".image-crop-resize-handler").each(function(){a(this).css({display:"none"});});break;default:var V=(A&&x.allowResize)?"block":"none";c.css({cursor:"nw-resize",display:V,left:x.selectionPosition[0]-Math.round(c.width()/2),top:x.selectionPosition[1]-Math.round(c.height()/2)});z.css({cursor:"n-resize",display:V,left:x.selectionPosition[0]+Math.round(x.selectionWidth/2-J.width()/2)-1,top:x.selectionPosition[1]-Math.round(J.height()/2)});J.css({cursor:"ne-resize",display:V,left:x.selectionPosition[0]+x.selectionWidth-Math.round(J.width()/2)-1,top:x.selectionPosition[1]-Math.round(J.height()/2)});i.css({cursor:"w-resize",display:V,left:x.selectionPosition[0]-Math.round(J.width()/2),top:x.selectionPosition[1]+Math.round(x.selectionHeight/2-J.height()/2)-1});T.css({cursor:"e-resize",display:V,left:x.selectionPosition[0]+x.selectionWidth-Math.round(J.width()/2)-1,top:x.selectionPosition[1]+Math.round(x.selectionHeight/2-J.height()/2)-1});e.css({cursor:"sw-resize",display:V,left:x.selectionPosition[0]-Math.round(e.width()/2),top:x.selectionPosition[1]+x.selectionHeight-Math.round(e.height()/2)-1});k.css({cursor:"s-resize",display:V,left:x.selectionPosition[0]+Math.round(x.selectionWidth/2-L.width()/2)-1,top:x.selectionPosition[1]+x.selectionHeight-Math.round(L.height()/2)-1});L.css({cursor:"se-resize",display:V,left:x.selectionPosition[0]+x.selectionWidth-Math.round(L.width()/2)-1,top:x.selectionPosition[1]+x.selectionHeight-Math.round(L.height()/2)-1});}}function O(U){switch(U){case"focus":g.stop().animate({opacity:x.previewFadeOnFocus});break;case"blur":g.stop().animate({opacity:x.previewFadeOnBlur});break;case"hide":g.css({display:"none"});break;default:var V=(A&&x.displayPreview)?"block":"none";g.css({display:V,left:x.selectionPosition[0],top:x.selectionPosition[1]+x.selectionHeight+10});if(x.selectionWidth>x.selectionHeight){if(x.selectionWidth&&x.selectionHeight){p.width(Math.round(C.width()*x.previewBoundary/x.selectionWidth));p.height(Math.round(C.height()*p.width()/C.width()));g.width(x.previewBoundary).height(Math.round(x.selectionHeight*p.height()/C.height()));}}else{if(x.selectionWidth&&x.selectionHeight){p.height(Math.round(C.height()*x.previewBoundary/x.selectionHeight));p.width(Math.round(C.width()*p.height()/C.height()));g.width(Math.round(x.selectionWidth*p.width()/C.width())).height(x.previewBoundary);}}p.css({left:-Math.round(x.selectionPosition[0]*p.width()/C.width()),top:-Math.round(x.selectionPosition[1]*p.height()/C.height())});}}function P(U){s.css({cursor:U});M.css({cursor:U});E.css({cursor:U});d.css({cursor:U});S.css({cursor:U});}function u(U){switch(U){case"setSelection":Q();K();t("hide-all");O("hide");break;case"pickSelection":t("hide-all");break;case"pickResizeHandler":y();t("hide-all");break;case"resizeSelection":K();y();t("hide-all");O();P("crosshair");break;case"moveSelection":K();t("hide-all");O();P("move");break;case"releaseSelection":f();Q();K();y("fade-out");t();O();break;default:f();Q();K();t();O();}}function G(U){U.preventDefault();U.stopPropagation();a(document).mousemove(v);a(document).mouseup(b);if(x.displayPreview){g.mouseenter(function(){O("focus");});g.mouseleave(function(){O("blur");});}A=true;x.selectionWidth=0;x.selectionHeight=0;w=q(U);x.selectionPosition[0]=w[0];x.selectionPosition[1]=w[1];u("setSelection");}function j(U){U.preventDefault();U.stopPropagation();a(document).mousemove(m);a(document).mouseup(b);var V=q(U);r[0]=V[0]-x.selectionPosition[0];r[1]=V[1]-x.selectionPosition[1];u("pickSelection");}function h(U){U.preventDefault();U.stopPropagation();switch(U.target.id){case"image-crop-nw-resize-handler":w[0]+=x.selectionWidth;w[1]+=x.selectionHeight;x.selectionPosition[0]=w[0]-x.selectionWidth;x.selectionPosition[1]=w[1]-x.selectionHeight;break;case"image-crop-n-resize-handler":w[1]+=x.selectionHeight;x.selectionPosition[1]=w[1]-x.selectionHeight;n=false;break;case"image-crop-ne-resize-handler":w[1]+=x.selectionHeight;x.selectionPosition[1]=w[1]-x.selectionHeight;break;case"image-crop-w-resize-handler":w[0]+=x.selectionWidth;x.selectionPosition[0]=w[0]-x.selectionWidth;B=false;break;case"image-crop-e-resize-handler":B=false;break;case"image-crop-sw-resize-handler":w[0]+=x.selectionWidth;x.selectionPosition[0]=w[0]-x.selectionWidth;break;case"image-crop-s-resize-handler":n=false;break;}a(document).mousemove(v);a(document).mouseup(b);u("pickResizeHandler");}function v(W){W.preventDefault();W.stopPropagation();var X=q(W);var U=X[1]-w[1],V=X[0]-w[0];if(Math.abs(V)<x.minSize[0]){V=(V>=0)?x.minSize[0]:-x.minSize[0];}if(Math.abs(U)<x.minSize[1]){U=(U>=0)?x.minSize[1]:-x.minSize[1];}if(w[0]+V<0||w[0]+V>C.width()){V=-V;}if(w[1]+U<0||w[1]+U>C.height()){U=-U;}if(x.maxSize[0]>x.minSize[0]&&x.maxSize[1]>x.minSize[1]){if(Math.abs(V)>x.maxSize[0]){V=(V>=0)?x.maxSize[0]:-x.maxSize[0];}if(Math.abs(U)>x.maxSize[1]){U=(U>=0)?x.maxSize[1]:-x.maxSize[1];}}if(n){x.selectionWidth=V;}if(B){x.selectionHeight=U;}if(x.aspectRatio){if((V>0&&U>0)||(V<0&&U<0)){if(n){U=Math.round(V/x.aspectRatio);}else{V=Math.round(U*x.aspectRatio);}}else{if(n){U=-Math.round(V/x.aspectRatio);}else{V=-Math.round(U*x.aspectRatio);}}if(w[0]+V>C.width()){V=C.width()-w[0];U=(U>0)?Math.round(V/x.aspectRatio):-Math.round(V/x.aspectRatio);}if(w[1]+U<0){U=-w[1];V=(V>0)?-Math.round(U*x.aspectRatio):Math.round(U*x.aspectRatio);}if(w[1]+U>C.height()){U=C.height()-w[1];V=(V>0)?Math.round(U*x.aspectRatio):-Math.round(U*x.aspectRatio);}x.selectionWidth=V;x.selectionHeight=U;}if(x.selectionWidth<0){x.selectionWidth=Math.abs(x.selectionWidth);x.selectionPosition[0]=w[0]-x.selectionWidth;}else{x.selectionPosition[0]=w[0];}if(x.selectionHeight<0){x.selectionHeight=Math.abs(x.selectionHeight);x.selectionPosition[1]=w[1]-x.selectionHeight;}else{x.selectionPosition[1]=w[1];}x.onChange(l());u("resizeSelection");}function m(U){U.preventDefault();U.stopPropagation();var V=q(U);if(V[0]-r[0]>0){if(V[0]-r[0]+x.selectionWidth<C.width()){x.selectionPosition[0]=V[0]-r[0];}else{x.selectionPosition[0]=C.width()-x.selectionWidth;}}else{x.selectionPosition[0]=0;}if(V[1]-r[1]>0){if(V[1]-r[1]+x.selectionHeight<C.height()){x.selectionPosition[1]=V[1]-r[1];}else{x.selectionPosition[1]=C.height()-x.selectionHeight;}}else{x.selectionPosition[1]=0;}x.onChange(l());u("moveSelection");}function b(U){U.preventDefault();U.stopPropagation();a(document).unbind("mousemove");a(document).unbind("mouseup");w[0]=x.selectionPosition[0];w[1]=x.selectionPosition[1];n=true;B=true;if(x.selectionWidth>x.minSelect[0]&&x.selectionHeight>x.minSelect[1]){A=true;}else{A=false;}x.onSelect(l());if(!A){g.unbind("mouseenter");g.unbind("mouseleave");}u("releaseSelection");}};a.fn.imageCrop=function(b){this.each(function(){var c=this,d=new Image();d.onload=function(){a.imageCrop(c,b);};d.src=c.src;});return this;};})(jQuery);